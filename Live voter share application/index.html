<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abtak News</title>
</head>
<style>
    h1 {
        text-align: center;
    }

    #vote-box {
        display: flex;
        width: 70%;
        margin: auto;
    }

    #vote-box>div {
        border: 1px solid red;
        width: 50%;
        padding: 0 20px;
    }

    #container {
        margin-top: 20px;
        display: none;
    }

    #container>div {
        display: flex;
        gap: 20px;
    }

    #container button {
        height: 40px;
    }
</style>

<body>
    <h1>Live Voting</h1>
    <div id="vote-box">
        <div>
            <h2>Vote share percentage of each party</h2>
            <div id="vote-percentage">

            </div>
        </div>
        <div>
            <h2>All Votes</h2>
            <input type="number" placeholder="Enter your id" id="vote">
            <button onclick="submit()">submit</button>
            <div id="container">
                <div>
                    <p>A Party: <span>10</span></p>
                    <button>vote</button>
                </div>
                <div>
                    <p>A Party: <span>10</span></p>
                    <button>vote</button>
                </div>
                <div>
                    <p>A Party: <span>10</span></p>
                    <button>vote</button>
                </div>

            </div>
        </div>
    </div>
</body>
<script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
    integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
    crossorigin="anonymous"></script>
<script>
    const socket = io("http://localhost:7000/", { transports: ["websocket"] });
    const votesPercentage = document.getElementById("vote-percentage");
    const container = document.getElementById("container");
    const voterId = document.getElementById("vote");
    let global;

    socket.on("message", (msg) => {
        msg = msg.split("|");
        let votes = JSON.parse(msg[0]);
        let voters = JSON.parse(msg[1]);
        console.log(votes, voters)
        appendShare(votes);
        appendVotes(votes, voters)
        global = voters;
    })

    function appendShare(obj) {
        votesPercentage.innerHTML = ""
        let totalVotes = 0;
        for (let i of obj) {
            totalVotes += i.votes;
        }

        for (let i of obj) {
            votesPercentage.innerHTML += `
                <p>${i.name} Party: <span>${Math.round((i.votes / totalVotes) * 100)}%</span></p>
            `
        }
    }

    function appendVotes(obj, arr) {
        container.innerHTML = ""
        for (let i of obj) {
            container.innerHTML += `
                <div>
                    <p>${i.name} Party: <span>${i.votes}</span></p>
                    <button onclick="incVote(${i.id})">vote</button>
                </div>
            `
        }
    }

    function submit() {
        setTimeout(() => {
            if (!voterId.value) {
                alert("enter your voters id to see all votes");
            }


            if (global !== undefined) {

                if (global.includes(+voterId.value)) {
                    alert("already voted wait till next year");
                    return true;
                }

                container.style.display = "block";
            }

        }, 0)

    }

    function check() {
        if (global.includes(+voterId.value)) {
            return true;
        }

        return false;
    }

    function incVote(n) {
        if (check()) {
            return alert("already voted wait till next year");
        }
        socket.emit("message", `${n}|${voterId.value}`)
    }
</script>

</html>